version: "2.4"

#
# [ volumes definition ]
#
# creates Docker volumes which can be mounted by other containers too e.g. for backup
#
volumes:
  # logs:
  #   name: homestead_logs
  files:
    name: homestead_files
  dbdata:
    name: homestead_dbdata

#
# [ networks definition ]
#
# networks:
#   frontend:
#     driver: bridge
#   backend:
#     driver: bridge

services:
  #
  # [ server stack ]
  #
  # - php-cli
  # - mysql
  # - adminer
  # - phpmyadmin
  #
  php-cli:
    image: rodrixcornell/php:7.2-mysql-cli
    container_name: php-cli
    hostname: php-cli

    cpu_shares: 128
    mem_reservation: 128m
    mem_limit: 256m
    memswap_limit: -1
    privileged: true
    restart: always

    env_file:
    - .env

    environment:
      docker: "true"
      # https_proxy: "${https_proxy}"
      # http_proxy: "${http_proxy}"
      # ftp_proxy: "${ftp_proxy}"
      # no_proxy: "${no_proxy}"
      TZ: "America/Manaus"
      LANG: "pt_BR"
      LANGUAGE: "pt_BR:pt:en"
      APP_TZ: "America/Manaus"
      LOG_CHANNEL: "stderr"
      DB_CONNECTION: "mysql"
      DB_HOST: "mysql"
      DB_PORT: "3306"
      DB_DATABASE: "homestead"
      DB_USERNAME: "homestead"
      DB_PASSWORD: "secret"

    ports:
      - 8080:8080

    extra_hosts:
      - pitua:172.17.104.15
      - curuduri:172.17.131.45
      - cubatao:172.17.131.4
      - divisa:172.17.131.24
      - jaragua:172.17.131.44
      - ararangua:172.17.135.110

    # working_dir: /var/www
    # working_dir: /api
    working_dir: /opt/app-root/src

    volumes:
      # - .:/var/www
      - .:/opt/app-root/src
      - /tmp:/opt/app-root/src/storage/logs
      - /tmp:/opt/app-root/src/storage/framework/views
      - /tmp:/opt/app-root/src/storage/framework/testing
      - /tmp:/opt/app-root/src/storage/framework/sessions
      - /tmp:/opt/app-root/src/storage/framework/cache/data
      # - ./docker/php/files:/opt/app-root/src/public/files
      - files:/opt/app-root/src/storage/app/public/files

    depends_on:
      - mysql

    links:
      - mysql

    network_mode: bridge
    # networks:
    #   - backend

    # command: php -welsS [::]:8080 -t public public/index.php
    command: ./artisan serve --verbose --no-interaction --host=php-cli --port=8080
    # command: bash -c ".docker/./wait-for-it.sh mysql:3306 -s -t 0 -- ./artisan migrate:fresh --verbose --drop-views --force --seed && ./artisan serve --verbose --no-interaction --host=php-cli --port=8080"

  mysql:
    # image: mysql:5.7.29
    image: mysql:8.0.19
    container_name: mysql
    hostname: mysql

    cpu_shares: 128
    mem_reservation: 128m
    mem_limit: 256m
    memswap_limit: -1
    privileged: true
    restart: always

    environment:
      TZ: "America/Manaus"
      LANG: "pt_BR"
      LANGUAGE: "pt_BR:pt:en"
      MYSQL_ROOT_PASSWORD: "secret"
      MYSQL_DATABASE: "homestead"
      MYSQL_USER: "homestead"
      MYSQL_PASSWORD: "secret"
      MYSQL_ALLOW_EMPTY_PASSWORD: "false"
      MYSQL_RANDOM_ROOT_PASSWORD: "false"

    ports:
      - 3306:3306
      - 33060:33060

    working_dir: /var/lib/mysql

    volumes:
      # - ./.docker/mysql/initial_data:/docker-entrypoint-initdb.d
      - dbdata:/var/lib/mysql

    network_mode: bridge
    # networks:
    #   - backend

    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --default-authentication-plugin=mysql_native_password

  adminer:
    image: adminer:4.7.6
    container_name: adminer
    hostname: adminer

    cpu_shares: 128
    mem_reservation: 128m
    mem_limit: 256m
    memswap_limit: -1
    privileged: true
    restart: always

    environment:
      ADMINER_DESIGN: nette
      ADMINER_DEFAULT_SERVER: mysql

    ports:
      - 33061:8080

    depends_on:
      - mysql

    links:
      - mysql

    network_mode: bridge
    # networks:
    #   - frontend
    #   - backend

  redmine:
    image: redmine:4.1.1-passenger
    container_name: redmine
    hostname: redmine

    cpu_shares: 128
    mem_reservation: 128m
    mem_limit: 256m
    memswap_limit: -1
    privileged: true
    restart: always

    environment:
      TZ: "America/Manaus"
      LANG: "pt_BR"
      LANGUAGE: "pt_BR:pt:en"
      RAILS_ENV: "development"
      REDMINE_DB_MYSQL: "mysql"
      REDMINE_DB_PORT: "3306"
      REDMINE_DB_DATABASE: "homestead"
      REDMINE_DB_USERNAME: "homestead"
      REDMINE_DB_PASSWORD: "secret"
      REDMINE_DB_ENCODING: "utf8mb4"
      REDMINE_SECRET_KEY_BASE: "usEoHzvE@#q*@cj1tMSdcg"

    ports:
      - 3000:3000

    working_dir: /usr/src/redmine

    volumes:
      - ./.docker/redmine/config/additional_environment.rb:/usr/src/redmine/config/additional_environment.rb
      - ./.docker/redmine/config/configuration.yml:/usr/src/redmine/config/configuration.yml
      # - ./.docker/redmine/config:/usr/src/redmine/config
      # - ./.docker/redmine/sqlite:/usr/src/redmine/sqlite
      # - ./.docker/redmine/log:/usr/src/redmine/log
      # - ./.docker/redmine/files:/usr/src/redmine/files
      # - ./.docker/redmine/public/plugin_assets:/usr/src/redmine/public/plugin_assets
      - files:/usr/src/redmine/files

    depends_on:
      - mysql

    links:
      - mysql

    network_mode: bridge
    # networks:
    #   - backend
